<app-navbar></app-navbar>
<div class="container">
  <h2 class="title">Inscripci√≥n de Materias</h2>

  <div class="form-group">
    <label for="registro">N√∫mero de registro:</label>
    <input
      type="number"
      id="registro"
      [(ngModel)]="registro"
      placeholder="Ingrese n√∫mero de registro"
      [disabled]="isLoading || isSubmitting"
      class="input-field"
    />
  </div>

  <button
    (click)="buscarEstudiante()"
    [disabled]="!registro || isLoading || isSubmitting"
    class="btn btn-primary"
  >
    <ng-container *ngIf="isLoading; else buscarTexto">
      <span class="spinner"></span> Buscando...
    </ng-container>
    <ng-template #buscarTexto>Buscar Estudiante</ng-template>
  </button>

  <div *ngIf="error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="success" class="alert alert-success">{{ success }}</div>

  <div *ngIf="estudiante" class="student-info">
    <h3>Datos del Estudiante</h3>
    <p><strong>Nombre:</strong> {{ estudiante.nombre }} {{ estudiante.apellidoPaterno }} {{ estudiante.apellidoMaterno }}</p>
    <p><strong>CI:</strong> {{ estudiante.ci }}</p>
    <p><strong>Fecha de nacimiento:</strong> {{ estudiante.fechaNacimiento | date:'dd/MM/yyyy' }}</p>

    <h3>Oferta de Materias</h3>

    <div *ngIf="oferta.length === 0" class="empty-message">
      No hay materias disponibles para inscripci√≥n.
    </div>

    <div *ngFor="let materia of oferta" class="materia-card" [class.sin-cupos-disponibles]="!tieneGruposConCupo(materia)">
      <div class="materia-header">
        <h4>{{ materia.nombre }} ({{ materia.sigla }})
          <span *ngIf="!tieneGruposConCupo(materia)" class="warning-badge">Sin cupos disponibles</span>
        </h4>
        <p><strong>Nivel:</strong> {{ materia.nivel }}, <strong>Horas:</strong> {{ materia.horasDeEstudio }}</p>
      </div>

      <div *ngIf="materia.Grupo_Materia?.length > 0" class="grupos-list">
        <div class="grupos-header">
          <span class="grupos-title">Grupos disponibles:</span>
          <span class="grupos-count">{{ getGruposConCupo(materia).length }} de {{ materia.Grupo_Materia.length }} con cupos</span>
        </div>
        
        <label *ngFor="let grupo of materia.Grupo_Materia" 
               class="grupo-option" 
               [class.grupo-sin-cupo]="grupo.cupo === 0"
               [class.grupo-seleccionado]="selectedMaterias[materia.id] === grupo.id">
          <input
            type="radio"
            [name]="'grupo_' + materia.id"
            [value]="grupo.id"
            (change)="seleccionarGrupo(materia.id, grupo.id)"
            [checked]="selectedMaterias[materia.id] === grupo.id"
            [disabled]="isSubmitting || grupo.cupo === 0"
          />
          
          <div class="grupo-info">
            <div class="grupo-principal">
              <span class="grupo-text">
                Grupo: <strong>{{ grupo.sigla }}</strong>
              </span>
              <span class="cupo-badge" [class.sin-cupo]="grupo.cupo === 0" [class.con-cupo]="grupo.cupo > 0">
                <span class="cupo-icon">üë•</span>
                {{ grupo.cupo }} cupos
              </span>
            </div>
            
            <div class="docente-info">
              <span class="docente-icon">üë®‚Äçüè´</span>
              Docente: {{ grupo.Docente?.nombre }} {{ grupo.Docente?.apellidoPaterno }}
            </div>
            
            <div *ngIf="grupo.AulaHorarios?.length > 0" class="horarios">
              <span class="horario-icon">üïê</span>
              Horarios:
              <span *ngFor="let horario of grupo.AulaHorarios; let last = last" class="horario-item">
                {{ horario.Horario.dia }} {{ horario.Horario.inicio }}-{{ horario.Horario.final }} en Aula {{ horario.Aula.numero }}{{ last ? '' : ', ' }}
              </span>
            </div>
            
            <div *ngIf="!grupo.AulaHorarios || grupo.AulaHorarios.length === 0" class="no-horarios">
              <span class="warning-icon"></span>
              Sin horarios disponibles
            </div>
            
            <div *ngIf="grupo.cupo === 0" class="cupo-agotado-mensaje">
              <span class="error-icon"></span>
              Cupos agotados para este grupo
            </div>
          </div>
        </label>
      </div>

      <div *ngIf="!materia.Grupo_Materia || materia.Grupo_Materia.length === 0" class="empty-message">
        No hay grupos disponibles para esta materia.
      </div>
    </div>

    <button
      class="btn btn-success"
      (click)="inscribirMaterias()"
      [disabled]="materiasSeleccionadasCount === 0 || showInscripcionModal"
    >
      Inscribir Materias ({{ materiasSeleccionadasCount }})
    </button>
  </div>
</div>

<!-- Modal de Estado de Inscripci√≥n -->
<div *ngIf="showInscripcionModal" class="modal-overlay" (click)="$event.target === $event.currentTarget && inscripcionCompleta && cerrarModal()">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Estado de Inscripci√≥n</h3>
      <button *ngIf="inscripcionCompleta" class="close-btn" (click)="cerrarModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <!-- Barra de progreso -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="inscripcionProgreso" [ngClass]="'progress-' + inscripcionEstado"></div>
        </div>
        <span class="progress-text">{{ inscripcionProgreso }}%</span>
      </div>

      <!-- Estado e √≠cono -->
      <div class="estado-container">
        <div class="estado-icon" [ngClass]="'estado-' + inscripcionEstado">
          <ng-container [ngSwitch]="inscripcionEstado">
            <span *ngSwitchCase="'iniciando'" class="spinner-modal"></span>
            <span *ngSwitchCase="'enviando'" class="spinner-modal"></span>
            <span *ngSwitchCase="'waiting'" class="clock-icon">‚è≥</span>
            <span *ngSwitchCase="'procesando'" class="processing-icon">‚öôÔ∏è</span>
            <span *ngSwitchCase="'exitoso'" class="success-icon">‚úÖ</span>
            <span *ngSwitchCase="'sin-cupos'" class="warning-icon">‚ö†Ô∏è</span>
            <span *ngSwitchCase="'error'" class="error-icon">‚úÖ</span>
          </ng-container>
        </div>
        
        <div class="estado-mensaje">
          <h4>{{ inscripcionMensaje }}</h4>
          
          <!-- Informaci√≥n adicional para sin cupos -->
          <div *ngIf="inscripcionEstado === 'sin-cupos' && sinCuposInfo.length > 0" class="sin-cupos-modal-details">
            <h5>Materias sin cupos:</h5>
            <div *ngFor="let grupo of sinCuposInfo" class="sin-cupo-modal-item">
              <strong>{{ grupo.Materium.nombre }}</strong> - Grupo: {{ grupo.sigla }}
              <span class="cupo-disponible">Cupos disponibles: {{ grupo.cupo }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones del modal -->
    <div class="modal-footer" *ngIf="inscripcionCompleta">
      <button class="btn btn-primary" (click)="cerrarModal()">
        {{ inscripcionEstado === 'exitoso' ? 'Continuar' : 'Cerrar' }}
      </button>
    </div>
  </div>
</div>
